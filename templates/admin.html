<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Market - Admin Paneli</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="hud" style="background: #220000; border-bottom: 2px solid red;">
        <div class="container hud-content">
            <div class="hud-item">
                <span class="hud-label" style="color:red">YÃ–NETÄ°CÄ° MODU</span>
                <span class="hud-value">Paramen42</span>
            </div>
            <div class="hud-item" style="flex-grow:1; text-align:right;">
                <a href="/game" class="btn btn-sm btn-secondary">Oyuna DÃ¶n</a>
            </div>
        </div>
    </div>

    <div class="container" style="margin-top: 80px;">
        <div class="card">
            <h2>ðŸ”´ YÃ¶netim Paneli</h2>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:8px;">
                    <h3>Sistem Duyurusu</h3>
                    <input type="text" id="broadcast-msg" placeholder="MesajÄ±nÄ±z..." style="width:100%; margin-bottom:10px;">
                    <button class="btn btn-danger" onclick="adminAction('broadcast')">YAYINLA</button>
                </div>
                <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:8px;">
                    <h3>Ekonomi YÃ¶netimi</h3>
                    <div id="economy-stats" style="margin-bottom:10px;">YÃ¼kleniyor...</div>
                    <hr style="border-color:#444">
                    <h4>ÃœrÃ¼n FiyatlarÄ± (Base)</h4>
                    <div style="margin-bottom:10px; display:flex; gap:5px;">
                        <input type="text" id="new-item-key" placeholder="Kod (Ã¶rn: bakir)" style="width:30%" class="form-input">
                        <input type="text" id="new-item-name" placeholder="Ä°sim" style="width:30%" class="form-input">
                        <input type="number" id="new-item-price" placeholder="Fiyat" style="width:20%" class="form-input">
                        <button class="btn btn-xs btn-success" onclick="addItem()">EKLE</button>
                    </div>
                    <div id="admin-items-list" style="max-height:150px; overflow-y:auto; font-size:0.9em;">
                        <!-- JS ile dolacak -->
                    </div>
                </div>
            </div>

            <h3>ðŸ‘¤ KullanÄ±cÄ±lar</h3>
            <div style="overflow-x:auto;">
                <table style="width:100%; text-align:left;">
                    <thead>
                        <tr>
                            <th>KullanÄ±cÄ±</th>
                            <th>Para</th>
                            <th>Seviye</th>
                            <th>Son Aktif</th>
                            <th>Durum</th>
                            <th>Ä°ÅŸlemler</th>
                        </tr>
                    </thead>
                    <tbody id="user-list">
                        <!-- JS ile dolacak -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="/static/js/main.js"></script>
    <script>
        // Inline Admin Script for simplicity
        async function loadAdminStats() {
            const res = await fetch('/api/admin/stats');
            if (!res.ok) {
                window.location.href = '/game';
                return;
            }
            const data = await res.json();
            
            // Economy
            document.getElementById('economy-stats').innerHTML = `
                Pazar Ä°lanlarÄ±: ${data.market_count}<br>
                Ã‡arpan: x${data.economy.multiplier}<br>
                Trend: ${data.economy.trend}
            `;
            
            // Users
            const tbody = document.getElementById('user-list');
            tbody.innerHTML = data.users.map(u => `
                <tr>
                    <td>${u.username}</td>
                    <td>${u.money}</td>
                    <td>${u.level}</td>
                    <td>${u.last_active}</td>
                    <td>${u.banned ? '<span style="color:red">BANLI</span>' : '<span style="color:green">AKTÄ°F</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="adminAction('ban', '${u.username}')">BAN</button>
                        <button class="btn btn-sm btn-success" onclick="adminAction('unban', '${u.username}')">AÃ‡</button>
                        <button class="btn btn-sm btn-warning" onclick="promptMoney('${u.username}')">PARA VER</button>
                        <button class="btn btn-sm btn-info" onclick="adminAction('reset_mission', '${u.username}')">GÃ–REV SIFIRLA</button>
                    </td>
                </tr>
            `).join('');
            
            // Load Items for Price Editing
            const marketRes = await fetch('/api/market');
            const marketData = await marketRes.json();
            const itemsDiv = document.getElementById('admin-items-list');
             itemsDiv.innerHTML = Object.entries(marketData.items).map(([key, item]) => `
                 <div style="display:flex; justify-content:space-between; margin-bottom:5px; align-items:center;">
                     <span style="width:30%">${item.name}</span>
                     <input type="number" value="${item.base_price}" 
                            style="width:50px; padding:2px; background:#333; color:white; border:1px solid #555"
                            onchange="updatePrice('${key}', this.value)">
                     <button class="btn btn-xs btn-danger" onclick="deleteItem('${key}')">X</button>
                 </div>
             `).join('');
         }
         
         async function addItem() {
             const key = document.getElementById('new-item-key').value;
             const name = document.getElementById('new-item-name').value;
             const price = document.getElementById('new-item-price').value;
             
             if (!key || !name || !price) return alert("Eksik bilgi!");
             
             await fetch('/api/admin/market', {
                 method: 'POST',
                 headers: {'Content-Type': 'application/json'},
                 body: JSON.stringify({
                     action: 'add_item',
                     key, name, price, rarity: 1
                 })
             });
             loadAdminStats();
         }

         async function deleteItem(key) {
             if(!confirm(key + ' silinsin mi?')) return;
             await fetch('/api/admin/market', {
                 method: 'POST',
                 headers: {'Content-Type': 'application/json'},
                 body: JSON.stringify({
                     action: 'delete_item',
                     key
                 })
             });
             loadAdminStats();
         }

         async function updatePrice(item, price) {
            await fetch('/api/admin/market', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: 'update_price',
                    item: item,
                    price: parseInt(price)
                })
            });
        }
        
        async function adminAction(action, user=null) {
            let body = { action, target_user: user };
            
            if (action === 'broadcast') {
                body.message = document.getElementById('broadcast-msg').value;
            } else if (action === 'add_money') {
                // Handled in promptMoney
            }
            
            await fetch('/api/admin/action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            
            if (action === 'broadcast') document.getElementById('broadcast-msg').value = '';
            loadAdminStats();
        }
        
        async function promptMoney(user) {
            const amount = prompt(`${user} kullanÄ±cÄ±sÄ±na ne kadar para verilsin?`);
            if (!amount) return;
            
            await fetch('/api/admin/action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: 'add_money',
                    target_user: user,
                    amount: parseInt(amount)
                })
            });
            loadAdminStats();
        }
        
        setInterval(loadAdminStats, 5000);
        loadAdminStats();
    </script>
</body>
</html>
