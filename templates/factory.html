{% extends "base.html" %}

{% block content %}
<div class="container main-game-area">
    <div class="card">
        <div class="card-header">
            <h2>üè≠ Fabrikalar</h2>
            <div class="hint-text">Fabrika durumlarƒ±, i≈ü√ßi atamalarƒ± ve √ºretim kontrol√º.</div>
        </div>
        <div id="factory-list"></div>
    </div>
    </div>

<script>
async function loadFactories() {
    const res = await fetch('/api/factories');
    if (!res.ok) return;
    const data = await res.json();
    const list = document.getElementById('factory-list');
    if (!data.length) {
        list.innerHTML = '<div class="hint-text">Fabrikanƒ±z yok veya veriler y√ºklenemedi.</div>';
        return;
    }
    list.innerHTML = `
      <div style="display:flex; gap:8px; margin-bottom:12px;">
        <input id="buy-workers-count" type="number" class="form-input" placeholder="Adet">
        <button class="btn btn-primary btn-sm" onclick="buyWorkers()">ƒ∞≈ü√ßi Satƒ±n Al (500 TL)</button>
        <div class="hint-text">Havuzdaki i≈ü√ßiler kapasiteye kadar fabrikalara atanabilir.</div>
      </div>
    ` + data.map(f => `
      <div class="factory-card" style="padding: 15px; border:1px solid #333; margin-bottom:10px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:bold">${f.name}</div>
          <div>Lv. <span id="level-${f.type}">${f.level}</span></div>
        </div>
        <div style="display:grid; grid-template-columns: repeat(2,1fr); gap:5px; margin-top:5px;">
          <div>√úretim (saatlik): <strong id="rate-${f.type}">${f.rate_per_hour}</strong></div>
          <div>ƒ∞≈ü√ßi: <strong>${f.worker_count}</strong> / Kapasite: <strong>${f.worker_capacity}</strong></div>
          <div>G√ºnl√ºk Gelir: <strong id="daily-${f.type}">${f.daily_income} TL</strong></div>
          <div>Durum: <strong>${f.running ? '√áalƒ±≈üƒ±yor' : 'Durduruldu'}</strong></div>
          <div>√úretim s√ºresi: <strong>${f.production_duration_minutes || '-'} dk</strong></div>
          <div>Son √ºretim: <strong>${f.last_collect_hours_ago} saat √∂nce</strong></div>
          <div>√úretim bonusu: <strong>%${f.bonus_pct}</strong></div>
          <div>Kalan s√ºre: <strong id="remain-${f.type}">${(f.collectable ? 'Toplanabilir' : formatRemain(f.remaining_seconds))}</strong></div>
          <div>Sonraki seviye maliyet: <strong id="cost-${f.type}">-</strong></div>
        </div>
        <div style="display:flex; gap:5px; margin-top:8px;">
          <button class="btn btn-success btn-sm" onclick="factoryStart('${f.type}')">√úretimi Ba≈ülat</button>
          <button class="btn btn-warning btn-sm" onclick="factoryStop('${f.type}')">√úretimi Durdur</button>
          <button class="btn btn-primary btn-sm" onclick="upgradeFactory('${f.type}')">Seviye Y√ºkselt</button>
          <button class="btn btn-success btn-sm" onclick="collectFactory('${f.type}')">√úretimi Topla</button>
        </div>
        <div style="display:flex; gap:5px; margin-top:8px;">
          <input type="number" id="assign-${f.type}" class="form-input" placeholder="ƒ∞≈ü√ßi adedi">
          <button class="btn btn-secondary btn-sm" onclick="assignWorkers('${f.type}')">ƒ∞≈ü√ßi Ekle</button>
          <button class="btn btn-secondary btn-sm" onclick="unassignWorkers('${f.type}')">ƒ∞≈ü√ßi √áƒ±kar</button>
        </div>
      </div>
    `).join('');
    // Per-second countdown update
    data.forEach(f => {
      const el = document.getElementById('remain-'+f.type);
      if (!el) return;
      if (typeof f.remaining_seconds !== 'number' || f.remaining_seconds === null) return;
      const endMs = Date.now() + f.remaining_seconds * 1000;
      const update = () => {
        const left = Math.max(0, endMs - Date.now());
        const s = Math.floor(left / 1000);
        el.textContent = s <= 0 ? 'Toplanabilir' : formatRemain(s);
        if (s > 0) requestAnimationFrame(update);
      };
      update();
    });
    // Fetch next cost per factory for display
    data.forEach(async f => {
      try {
        const res = await fetch('/api/factory_status/'+f.type);
        if (!res.ok) return;
        const st = await res.json();
        const costEl = document.getElementById('cost-'+f.type);
        if (costEl) costEl.textContent = st.next_cost ? (new Intl.NumberFormat('tr-TR').format(st.next_cost)+' TL') : '-';
      } catch (_) {}
    });
}
document.addEventListener('DOMContentLoaded', loadFactories);

async function factoryStart(type) {
  const res = await fetch('/api/factory/start', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({type})});
  const d = await res.json(); alert(d.message || '');
  loadFactories();
}
async function factoryStop(type) {
  const res = await fetch('/api/factory/stop', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({type})});
  const d = await res.json(); alert(d.message || '');
  loadFactories();
}
async function buyWorkers() {
  const count = parseInt(document.getElementById('buy-workers-count').value || '0');
  if (!count || count <= 0) return alert('Ge√ßerli adet girin');
  const res = await fetch('/api/workers/buy', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({count})});
  const d = await res.json(); alert(d.message || '');
  loadFactories();
}
function formatRemain(sec) {
  if (typeof sec !== 'number' || sec === null) return '--:--';
  const m = Math.floor(sec / 60), s = sec % 60;
  return m + ' dk ' + s + ' sn';
}
// Scroll position preservation (fallback if reload happens)
document.addEventListener('DOMContentLoaded', () => {
  const y = parseInt(localStorage.getItem('factory_scroll_y') || '0');
  if (y) window.scrollTo(0, y);
});
window.addEventListener('beforeunload', () => {
  localStorage.setItem('factory_scroll_y', String(window.scrollY || 0));
});
async function assignWorkers(type) {
  const count = parseInt(document.getElementById('assign-'+type).value || '0');
  if (!count || count <= 0) return alert('Ge√ßerli adet girin');
  const res = await fetch('/api/factory/assign_workers', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({type, count})});
  const d = await res.json(); alert(d.message || '');
  loadFactories();
}
async function unassignWorkers(type) {
  const count = parseInt(document.getElementById('assign-'+type).value || '0');
  if (!count || count <= 0) return alert('Ge√ßerli adet girin');
  const res = await fetch('/api/factory/unassign_workers', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({type, count})});
  const d = await res.json(); alert(d.message || '');
  loadFactories();
}
</script>
{% endblock %}
