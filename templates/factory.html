{% extends "base.html" %}

{% block content %}
<div class="container main-game-area">
    <div class="card">
        <div class="card-header">
            <h2>ğŸ­ Fabrikalar</h2>
            <div class="hint-text">Fabrika durumlarÄ±, iÅŸÃ§i atamalarÄ± ve Ã¼retim kontrolÃ¼.</div>
        </div>
        <div id="factory-list"></div>
    </div>
    </div>

<script>
async function loadFactories() {
    const res = await fetch('/api/factories');
    if (!res.ok) return;
    const data = await res.json();
    const list = document.getElementById('factory-list');
    if (!data.length) {
        list.innerHTML = '<div class="hint-text">FabrikanÄ±z yok veya veriler yÃ¼klenemedi.</div>';
        return;
    }
    list.innerHTML = `
      <div style="display:flex; gap:8px; margin-bottom:12px;">
        <input id="buy-workers-count" type="number" class="form-input" placeholder="Adet">
        <button class="btn btn-primary btn-sm" onclick="buyWorkers()">Ä°ÅŸÃ§i SatÄ±n Al (500 TL)</button>
        <div class="hint-text">Havuzdaki iÅŸÃ§iler kapasiteye kadar fabrikalara atanabilir.</div>
      </div>
    ` + data.map(f => `
      <div class="factory-card" style="padding: 15px; border:1px solid #333; margin-bottom:10px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:bold">${f.name}</div>
          <div>Lv. ${f.level}</div>
        </div>
        <div style="display:grid; grid-template-columns: repeat(2,1fr); gap:5px; margin-top:5px;">
          <div>Ãœretim (saatlik): <strong>${f.rate_per_hour}</strong></div>
          <div>Ä°ÅŸÃ§i: <strong>${f.worker_count}</strong> / Kapasite: <strong>${f.worker_capacity}</strong></div>
          <div>GÃ¼nlÃ¼k Gelir: <strong>${f.daily_income} TL</strong></div>
          <div>Durum: <strong>${f.running ? 'Ã‡alÄ±ÅŸÄ±yor' : 'Durduruldu'}</strong></div>
          <div>Ãœretim sÃ¼resi: <strong>3 saat</strong></div>
          <div>Son Ã¼retim: <strong>${f.last_collect_hours_ago} saat Ã¶nce</strong></div>
          <div>Ãœretim bonusu: <strong>%${f.bonus_pct}</strong></div>
        </div>
        <div style="display:flex; gap:5px; margin-top:8px;">
          <button class="btn btn-success btn-sm" onclick="factoryStart('${f.type}')">Ãœretimi BaÅŸlat</button>
          <button class="btn btn-warning btn-sm" onclick="factoryStop('${f.type}')">Ãœretimi Durdur</button>
          <button class="btn btn-primary btn-sm" onclick="upgradeFactory('${f.type}')">Seviye YÃ¼kselt</button>
          <button class="btn btn-success btn-sm" onclick="collectFactory('${f.type}')">Ãœretimi Topla</button>
        </div>
        <div style="display:flex; gap:5px; margin-top:8px;">
          <input type="number" id="assign-${f.type}" class="form-input" placeholder="Ä°ÅŸÃ§i adedi">
          <button class="btn btn-secondary btn-sm" onclick="assignWorkers('${f.type}')">Ä°ÅŸÃ§i Ekle</button>
          <button class="btn btn-secondary btn-sm" onclick="unassignWorkers('${f.type}')">Ä°ÅŸÃ§i Ã‡Ä±kar</button>
        </div>
      </div>
    `).join('');
}
document.addEventListener('DOMContentLoaded', loadFactories);

async function factoryStart(type) {
  const res = await fetch('/api/factory/start', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({type})});
  const d = await res.json(); alert(d.message || '');
  loadFactories();
}
async function factoryStop(type) {
  const res = await fetch('/api/factory/stop', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({type})});
  const d = await res.json(); alert(d.message || '');
  loadFactories();
}
async function buyWorkers() {
  const count = parseInt(document.getElementById('buy-workers-count').value || '0');
  if (!count || count <= 0) return alert('GeÃ§erli adet girin');
  const res = await fetch('/api/workers/buy', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({count})});
  const d = await res.json(); alert(d.message || '');
  loadFactories();
}
async function assignWorkers(type) {
  const count = parseInt(document.getElementById('assign-'+type).value || '0');
  if (!count || count <= 0) return alert('GeÃ§erli adet girin');
  const res = await fetch('/api/factory/assign_workers', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({type, count})});
  const d = await res.json(); alert(d.message || '');
  loadFactories();
}
async function unassignWorkers(type) {
  const count = parseInt(document.getElementById('assign-'+type).value || '0');
  if (!count || count <= 0) return alert('GeÃ§erli adet girin');
  const res = await fetch('/api/factory/unassign_workers', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({type, count})});
  const d = await res.json(); alert(d.message || '');
  loadFactories();
}
</script>
{% endblock %}
