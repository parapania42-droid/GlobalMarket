{% extends "base.html" %}

{% block content %}
    <!-- Mini-Event Popup -->
    <div id="event-popup" class="event-popup" style="display:none;">
        <div class="event-content">
            <div class="event-title" id="event-title">Etkinlik</div>
            <div class="event-desc" id="event-desc">Yeni bir mini etkinlik aktif!</div>
            <div class="event-actions">
                <button class="btn btn-success btn-sm" id="event-claim-btn">Ã–DÃœLÃœ AL</button>
                <button class="btn btn-secondary btn-sm" id="event-close-btn">Kapat</button>
            </div>
        </div>
    </div>

    <!-- HUD was moved to base.html -->
    <!-- We add an ID to this container so main.js knows it's the game page? 
         Actually main.js checks window.location.pathname.
         But for rendering, we need the containers.
    -->
    <div class="container main-game-area" id="game-page-container">
        <div class="card">
            <div class="card-header"><h2>ğŸ“Š Ã–zet</h2></div>
            <div id="home-summary" class="hint-text">YÃ¼kleniyor...</div>
        </div>
        <div class="card" style="margin-bottom:15px;">
            <div class="card-header"><h2>ğŸ’° CanlÄ± Piyasa</h2></div>
            <div id="home-price-list" class="inventory-grid"></div>
        </div>
        <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
             <button id="daily-bonus-btn" class="btn btn-sm btn-warning" onclick="claimDailyBonus()" style="display:none;">ğŸ GÃœNLÃœK Ã–DÃœL</button>
        </div>

        <!-- AFK UyarÄ±sÄ± -->
        <div id="active-status" style="display:none; background:var(--danger); color:white; padding:10px; border-radius:5px; margin-bottom:15px; text-align:center; font-weight:bold; animation:pulse 1s infinite;"></div>
        
        <!-- Ekonomi Durum BannerÄ± -->
        <div id="economy-status" class="economy-banner">
            KÃ¼resel pazara baÄŸlanÄ±lÄ±yor...
        </div>

        <div class="game-grid">
            <!-- SOL KOLON: PAZAR -->
            <div class="column-market" id="market">
                <div class="card">
                    <div class="card-header">
                        <h2>ğŸ›’ CanlÄ± Pazar</h2>
                        <div class="market-controls">
                            <button class="btn btn-xs" onclick="setSort('time')">YENÄ°</button>
                            <button class="btn btn-xs" onclick="setSort('price')">UCUZ</button>
                            <button class="btn btn-xs" onclick="setSort('item')">Ä°SÄ°M</button>
                        </div>
                    </div>
                    
                    <div class="market-list" id="market-list">
                        <!-- JS ile doldurulacak -->
                    </div>
                </div>
            </div>

            <!-- ORTA KOLON: HABERLER -->
            <div class="column-inventory">
                <div class="card">
                    <div class="card-header"><h3>ğŸ“° Piyasa Haberleri</h3></div>
                    <div id="home-news-list"></div>
                </div>
            </div>

            <!-- SAÄ KOLON: LÄ°DERLÄ°K -->
            <div class="column-factories">
                <div class="card">
                    <div class="card-header"><h3>ğŸ† Liderlik</h3></div>
                    <table style="width:100%;">
                        <thead><tr><th>#</th><th>KullanÄ±cÄ±</th><th>Servet</th></tr></thead>
                        <tbody id="home-leaderboard-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- CHAT BOX -->
    <div class="chat-container">
        <div class="chat-header" onclick="toggleChat()">
            ğŸ’¬ Global Sohbet
        </div>
        <div class="chat-body" id="chat-body">
            <div id="chat-messages" class="chat-messages">
                <!-- Mesajlar -->
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Mesaj yaz..." onkeypress="handleChatKey(event)">
                <button onclick="sendChat()">GÃ¶nder</button>
            </div>
        </div>
    </div>

    <!-- FACTORY MODAL TEMPLATE -->
    <div id="factory-modal" class="modal-overlay" style="display:none;" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modal-title">Fabrika <span id="modal-level-badge" style="font-size:0.6em; color:var(--primary)">Lv. 0</span></h2>
                <button class="btn btn-sm btn-danger" onclick="closeModal()">X</button>
            </div>
            
            <div class="modal-body">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <div>
                        <div>Ãœretim: <span id="modal-rate" style="color:var(--success)">0/dk</span></div>
                        <div>Depo: <span id="modal-storage">0</span> / <span id="modal-capacity">0</span></div>
                    </div>
                    <div style="text-align:right">
                         <div id="modal-status-text">Durum: Normal</div>
                         <button id="modal-boost-btn" class="btn btn-sm btn-warning">
                             âš¡ HIZLANDIR (1dk)
                         </button>
                    </div>
                </div>

                <div class="progress-bar">
                    <div id="modal-progress" class="progress-fill" style="width: 0%"></div>
                </div>
                
                <div style="margin-top:20px; padding:15px; background:rgba(0,0,0,0.2); border-radius:8px;">
                    <h4>YÃ¼kseltme</h4>
                    <p>Maliyet: <span id="modal-cost-text"></span></p>
                    <p id="modal-next-stats" style="font-size:0.9em; color:var(--text-muted)">Yeni Kapasite: - | Yeni HÄ±z: -</p>
                    <button id="modal-upgrade-btn" class="btn btn-primary" style="width:100%">
                        YÃœKSELT
                    </button>
                </div>

                <div style="margin-top:10px;">
                     <button id="modal-collect-btn" class="btn btn-success" style="width:100%; padding:15px;">
                        ğŸ“¦ DEPOYU TOPLA
                     </button>
                </div>
            </div>
        </div>
    </div>
    <script>
    async function loadSummary() {
        try {
            const [statsRes, invRes, tasksRes] = await Promise.all([
                fetch('/api/economy/stats'),
                fetch('/api/inventory'),
                fetch('/api/logistics/tasks')
            ]);
            if (!statsRes.ok) return;
            const stats = await statsRes.json();
            const inv = invRes.ok ? await invRes.json() : {items:[], total_value:0};
            const tasks = tasksRes.ok ? await tasksRes.json() : [];
            const el = document.getElementById('home-summary');
            const invTop = inv.items.slice(0,6).map(i => `${i.name}:${i.qty}`).join(', ');
            const activeTasks = tasks.filter(t => t.delivered === 0).length;
            el.innerHTML = `
              <div style="display:grid; grid-template-columns: repeat(2,1fr); gap:8px;">
                <div>Toplam Para: <strong>${stats.money} TL</strong></div>
                <div>Toplam Ä°ÅŸÃ§i: <strong>${stats.worker_count}</strong></div>
                <div>Envanter DeÄŸeri: <strong>${inv.total_value} TL</strong></div>
                <div>Aktif Lojistik GÃ¶revleri: <strong>${activeTasks}</strong></div>
                <div>Ã–zet Envanter: <strong>${invTop || '-'}</strong></div>
                <div>CanlÄ± Fiyatlar: <a href="/marketplace">Market</a></div>
              </div>
            `;
        } catch (e) {}
    }
    document.addEventListener('DOMContentLoaded', () => { loadSummary(); setInterval(loadSummary, 10000); });
    </script>
{% endblock %}
