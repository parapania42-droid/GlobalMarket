{% extends "base.html" %}

{% block content %}
<div class="container main-game-area">
  <div class="card">
    <div class="card-header">
      <h2>ğŸšš Lojistik</h2>
      <div class="hint-text">AraÃ§ satÄ±n alÄ±n, gÃ¶rev oluÅŸturun ve teslimatlarÄ± yÃ¶netin.</div>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
      <div>
        <h3>AraÃ§lar</h3>
        <div style="display:flex; gap:6px; margin-bottom:8px;">
          <button class="btn btn-secondary btn-sm" onclick="buyVehicle('Kamyonet')">Kamyonet (100) â€“ 10.000 TL</button>
          <button class="btn btn-secondary btn-sm" onclick="buyVehicle('Kamyon')">Kamyon (500) â€“ 50.000 TL</button>
          <button class="btn btn-secondary btn-sm" onclick="buyVehicle('TÄ±r')">TÄ±r (2000) â€“ 200.000 TL</button>
        </div>
        <div id="vehicle-list" class="hint-text">AraÃ§lar yÃ¼kleniyor...</div>
      </div>
      <div>
        <h3>GÃ¶rev OluÅŸtur</h3>
        <div class="input-group">
          <select id="task-vehicle" class="form-input"></select>
          <input id="task-item" class="form-input" placeholder="ÃœrÃ¼n adÄ± (Ã¶rn: Ã‡elik)">
        </div>
        <div class="input-group">
          <input id="task-amount" type="number" class="form-input" placeholder="Miktar">
          <select id="task-destination" class="form-input">
            <option>Market</option>
          </select>
        </div>
        <div class="input-group">
          <select id="task-scope" class="form-input">
            <option value="same">AynÄ± ÅŸehir (10 dk)</option>
            <option value="different">FarklÄ± ÅŸehir (30 dk)</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="createTask()">GÃ¶rev OluÅŸtur</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h3>Aktif GÃ¶revler</h3></div>
    <div id="task-list" class="hint-text">GÃ¶revler yÃ¼kleniyor...</div>
  </div>
</div>

<script>
async function loadVehicles() {
  const res = await fetch('/api/logistics/vehicles');
  if (!res.ok) return;
  const rows = await res.json();
  const list = document.getElementById('vehicle-list');
  if (!rows.length) {
    list.textContent = 'HenÃ¼z aracÄ±nÄ±z yok.';
  } else {
    list.innerHTML = rows.map(v => `<div>â€¢ ${v.type} â€” Kapasite: ${v.capacity} (ID: ${v.id})</div>`).join('');
  }
  const sel = document.getElementById('task-vehicle');
  sel.innerHTML = rows.map(v => `<option value="${v.id}">${v.type} (#${v.id})</option>`).join('');
}
async function buyVehicle(type) {
  const res = await fetch('/api/logistics/vehicles/buy', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({type})});
  const data = await res.json();
  alert(data.message || '');
  loadVehicles();
}
async function loadTasks() {
  const res = await fetch('/api/logistics/tasks');
  if (!res.ok) return;
  const rows = await res.json();
  const el = document.getElementById('task-list');
  if (!rows.length) {
    el.textContent = 'Aktif gÃ¶rev bulunmuyor.';
    return;
  }
  const now = Date.now()/1000;
  el.innerHTML = rows.map(t => {
    const remain = Math.max(0, Math.floor(t.eta - now));
    const min = Math.floor(remain / 60), sec = remain % 60;
    return `<div style="padding:6px; border-bottom:1px solid var(--border)">
      <strong>${t.item}</strong> Ã— ${t.amount} â†’ ${t.destination} â€” AraÃ§ #${t.vehicle_id}
      <div>${t.delivered ? 'TamamlandÄ±' : 'ETA: ' + min + ' dk ' + sec + ' sn'}</div>
    </div>`;
  }).join('');
}
async function createTask() {
  const vehicle_id = parseInt(document.getElementById('task-vehicle').value);
  const item = document.getElementById('task-item').value.trim();
  const amount = parseInt(document.getElementById('task-amount').value);
  const destination = document.getElementById('task-destination').value;
  const city_scope = document.getElementById('task-scope').value;
  if (!vehicle_id || !item || !amount || amount <= 0) {
    alert('GeÃ§erli bilgiler girin!');
    return;
  }
  const res = await fetch('/api/logistics/create_task', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({vehicle_id, item, amount, destination, city_scope})});
  const data = await res.json();
  alert(data.message || '');
  loadTasks();
}
document.addEventListener('DOMContentLoaded', () => { loadVehicles(); loadTasks(); setInterval(loadTasks, 5000); });
</script>
{% endblock %}
